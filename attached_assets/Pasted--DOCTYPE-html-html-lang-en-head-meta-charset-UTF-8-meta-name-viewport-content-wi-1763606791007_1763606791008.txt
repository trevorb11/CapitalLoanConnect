<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Funding Application</title>
<style>
/* Import Inter font */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #f0f2f5;
    margin: 0;
    padding: 20px;
}

/* Main Container */
#applicationContainer {
    background: linear-gradient(to bottom, #192F56 0%, #19112D 100%);
    color: white;
    padding: 3rem;
    border-radius: 15px;
    box-shadow: 0 12px 30px rgba(25, 47, 86, 0.3), 0 4px 15px rgba(0, 0, 0, 0.2);
    min-height: 600px;
    width: 100%;
    max-width: 900px; /* Wider than intake form for the 2-column layout */
    margin: 2rem auto;
    position: relative;
    overflow: hidden;
}

/* Progress Bar */
.progress-container {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    margin-bottom: 2.5rem;
}

.progress-bar {
    width: 50%; /* Starts at 50% for Step 1 */
    height: 100%;
    background: white;
    border-radius: 2px;
    transition: width 0.5s ease;
}

/* Headers */
h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
    text-align: center;
}

p.subtitle {
    color: rgba(255,255,255,0.7);
    text-align: center;
    margin-bottom: 2.5rem;
    font-size: 1rem;
}

/* Form Grid System */
.form-section {
    display: none; /* Hidden by default */
    opacity: 0;
    transition: opacity 0.5s ease;
}

.form-section.active {
    display: block;
    opacity: 1;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Input Styling */
.input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.input-group label {
    font-size: 0.9rem;
    font-weight: 500;
    color: rgba(255,255,255,0.9);
}

input, select {
    width: 100%;
    padding: 0.85rem 1rem;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s ease;
}

input:focus, select:focus {
    outline: none;
    border-color: white;
    background: rgba(255,255,255,0.15);
}

input::placeholder {
    color: rgba(255,255,255,0.5);
}

/* Remove autofill background in Chrome */
input:-webkit-autofill,
input:-webkit-autofill:hover, 
input:-webkit-autofill:focus, 
input:-webkit-autofill:active{
    -webkit-box-shadow: 0 0 0 30px #192F56 inset !important;
    -webkit-text-fill-color: white !important;
}

/* Select dropdown arrow */
select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}

select option {
    background-color: #192F56;
    color: white;
}

/* Buttons */
.btn-primary {
    width: 100%;
    background: white;
    color: #192F56;
    padding: 1rem 2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
}

.btn-primary:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    #applicationContainer {
        padding: 1.5rem;
        margin: 1rem auto;
    }
    
    .form-grid {
        grid-template-columns: 1fr; /* Stack columns on mobile */
        gap: 1rem;
    }
    
    h2 {
        font-size: 1.75rem;
    }
}

/* Error & Loading States */
.error-message {
    display: none;
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #ef4444;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
}

.loading-state {
    display: none;
    text-align: center;
    margin-top: 1rem;
    color: rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div id="applicationContainer">
    <!-- Progress Bar -->
    <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <!-- Step 1: Business Information -->
    <div id="step1" class="form-section active">
        <h2>Business Information</h2>
        <p class="subtitle">Please provide details about your business entity.</p>

        <form id="formStep1">
            <div class="form-grid">
                <!-- Left Column -->
                <div class="input-group">
                    <label>Legal Company Name</label>
                    <input type="text" name="legal_business_name" required>
                </div>
                <div class="input-group">
                    <label>Doing Business As (DBA)</label>
                    <input type="text" name="doing_business_as" required>
                </div>

                <div class="input-group">
                    <label>Company Website</label>
                    <input type="text" name="company_website">
                </div>
                <div class="input-group">
                    <label>Business Start Date</label>
                    <input type="date" name="business_start_date" required>
                </div>

                <div class="input-group">
                    <label>Tax ID or EIN</label>
                    <input type="text" name="ein" placeholder="XX-XXXXXXX" required>
                </div>
                <div class="input-group">
                    <label>Company Email</label>
                    <input type="email" name="company_email" required>
                </div>

                <div class="input-group">
                    <label>State of Incorporation</label>
                    <input type="text" name="state_of_incorporation" maxlength="2" placeholder="e.g. CA" required>
                </div>
                <div class="input-group">
                    <label>Do You Process Credit Cards?</label>
                    <select name="do_you_process_credit_cards" required>
                        <option value="" disabled selected>Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Industry Type</label>
                    <input type="text" name="industry" required>
                </div>
                <div class="input-group">
                    <label>Business Street Address</label>
                    <input type="text" name="business_street_address" required>
                </div>

                <div class="input-group">
                    <label>City, State, Zip</label>
                    <input type="text" name="business_csz" placeholder="City, ST 12345" required>
                </div>
                <div class="input-group">
                    <label>Financing Amount ($)</label>
                    <input type="number" name="requested_loan_amount" required>
                </div>

                <div class="input-group">
                    <label>MCA Balance Amount ($)</label>
                    <input type="number" name="mca_balance_amount" placeholder="0 if none">
                </div>
                <div class="input-group">
                    <label>MCA Balances Bank Name</label>
                    <input type="text" name="mca_balance_bank_name" placeholder="N/A if none">
                </div>
            </div>
            <button type="button" class="btn-primary" onclick="goToStep2()">Next: Owner Information</button>
        </form>
    </div>

    <!-- Step 2: Owner Information -->
    <div id="step2" class="form-section">
        <h2>Owner Information</h2>
        <p class="subtitle">Details for the primary business owner (51%+)</p>

        <form id="formStep2">
            <div class="form-grid">
                <!-- Left Column -->
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" name="full_name" required>
                </div>
                <div class="input-group">
                    <label>Business Email (Owner)</label>
                    <input type="email" name="email" required>
                </div>

                <div class="input-group">
                    <label>Social Security Number</label>
                    <input type="text" name="social_security_" placeholder="XXX-XX-XXXX" required>
                </div>
                <div class="input-group">
                    <label>Mobile Phone</label>
                    <input type="tel" name="phone" required>
                </div>

                <div class="input-group">
                    <label>FICO Score (Estimate)</label>
                    <input type="number" name="personal_credit_score_range" placeholder="e.g. 700">
                </div>
                <div class="input-group">
                    <label>Home Address Line 1</label>
                    <input type="text" name="address1" required>
                </div>

                <div class="input-group">
                    <label>Address Line 2</label>
                    <input type="text" name="address2">
                </div>
                 <div class="input-group">
                    <label>City, State, Zip (Owner)</label>
                    <input type="text" name="owner_csz" placeholder="City, ST 12345" required>
                </div>

                <div class="input-group">
                    <label>Date of Birth</label>
                    <input type="date" name="date_of_birth" required>
                </div>
                <div class="input-group">
                    <label>Ownership %</label>
                    <input type="number" name="ownership_percentage" placeholder="100" required>
                </div>
            </div>

            <!-- Consent / Compliance Footer -->
            <div style="margin: 2rem 0;">
                 <div style="display: flex; align-items: flex-start; text-align: left; gap: 0.75rem;">
                    <input type="checkbox" id="consentCheck" style="width: 16px; height: 16px; margin-top: 3px; cursor: pointer; flex-shrink: 0;" required>
                    <label for="consentCheck" style="color: rgba(255,255,255,0.6); font-size: 11px; line-height: 1.4; cursor: pointer; font-weight: 400;">
                        By submitting this application, I certify that all information provided is accurate and complete. I authorize Today Capital Group and its partners to obtain credit reports and other information to process my application. I agree to the <a href="https://www.todaycapitalgroup.com/terms-of-service" target="_blank" style="text-decoration: underline; color: rgba(255,255,255,0.8);">Terms of Service</a> and <a href="https://www.todaycapitalgroup.com/privacy-policy" target="_blank" style="text-decoration: underline; color: rgba(255,255,255,0.8);">Privacy Policy</a>.
                    </label>
                </div>
                 <div id="consentError" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 4px;">
                    <p style="color: #ef4444; font-size: 0.85rem; margin: 0;">Please accept the terms to continue</p>
                </div>
            </div>

            <button type="button" id="submitBtn" class="btn-primary" onclick="submitApplication()">Submit Full Application</button>
            
            <!-- Loading & Error -->
            <div id="loadingState" class="loading-state">
                <p>Submitting application securely...</p>
            </div>
            <div id="errorMessage" class="error-message">
                <p>There was an error submitting your application. Please try again.</p>
            </div>
        </form>
    </div>

    <!-- Success Step -->
    <div id="successStep" class="form-section" style="text-align: center; padding-top: 2rem;">
        <div style="width: 80px; height: 80px; margin: 0 auto 2rem; background: rgba(34, 197, 94, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid #22c55e;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
        </div>
        <h3 style="font-size: 2.2rem; margin-bottom: 1rem; font-weight: 600; color: #22c55e;">Application Received</h3>
        <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem;">
            Your full funding application has been submitted successfully.
        </p>
        <p style="color: rgba(255,255,255,0.8); font-size: 1rem; line-height: 1.5; margin-bottom: 2.5rem;">
            Our underwriting team is reviewing your details. You will receive an update via email within 24-48 hours.
        </p>
        <button onclick="window.location.href='/'" class="btn-primary" style="max-width: 300px;">Return to Home</button>
    </div>
</div>

<script>
// ============================================================
// WEBHOOK CONFIGURATION
// ============================================================
const ghlWebhookUrl = 'https://services.leadconnectorhq.com/hooks/n778xwOps9t8Q34eRPfM/webhook-trigger/b21b2392-b82b-49c9-a697-fa2d0c8bddd5'; 
const backupWebhookUrl = 'https://script.google.com/macros/s/AKfycbynygRwYHpg4joyMLY-IC_B_7cqrNlNl92HjHduc5OvUtrUgig7_aHG69CdSTKZ562w/exec'; 
// ============================================================

let applicationData = {};

function goToStep2() {
    const form1 = document.getElementById('formStep1');
    if (form1.checkValidity()) {
        // Collect Step 1 Data
        const formData = new FormData(form1);
        formData.forEach((value, key) => {
            applicationData[key] = value;
        });

        // Visual Transitions
        document.getElementById('step1').classList.remove('active');
        setTimeout(() => {
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            setTimeout(() => {
                document.getElementById('step2').classList.add('active');
                document.getElementById('progressBar').style.width = '100%';
                window.scrollTo(0, 0);
            }, 50);
        }, 500);
    } else {
        form1.reportValidity();
    }
}

async function submitApplication() {
    const form2 = document.getElementById('formStep2');
    const consent = document.getElementById('consentCheck').checked;
    const consentError = document.getElementById('consentError');
    
    // Reset Error States
    consentError.style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';

    if (!form2.checkValidity()) {
        form2.reportValidity();
        return;
    }

    if (!consent) {
        consentError.style.display = 'block';
        return;
    }

    // Collect Step 2 Data
    const formData = new FormData(form2);
    formData.forEach((value, key) => {
        applicationData[key] = value;
    });

    // Prepare Data for GHL (Split Name, Format, etc.)
    const nameParts = applicationData.full_name.trim().split(' ');
    const firstName = nameParts[0];
    const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
    
    // Parse City/State/Zip for Owner if combined
    // Simple naive split on comma if user followed "City, ST Zip" format
    // Just sending raw string for simplicity as fallback unless we add dedicated logic
    
    const finalPayload = {
        ...applicationData,
        first_name: firstName,
        last_name: lastName,
        submission_date: new Date().toISOString(),
        source: "Full Application Form",
        page_url: window.location.href,
        // Ensuring GHL standard fields are populated
        company_name: applicationData.legal_business_name,
        // Mapping specific GHL keys from your list
        years_in_business: getYearsFromDate(applicationData.business_start_date)
    };

    // UI Loading State
    const btn = document.getElementById('submitBtn');
    const loading = document.getElementById('loadingState');
    btn.disabled = true;
    btn.style.display = 'none';
    loading.style.display = 'block';

    try {
        const requests = [];
        if (ghlWebhookUrl) requests.push(fetch(ghlWebhookUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(finalPayload) }));
        if (backupWebhookUrl) requests.push(fetch(backupWebhookUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(finalPayload) }));

        await Promise.allSettled(requests);

        // Success Transition
        loading.style.display = 'none';
        document.getElementById('step2').classList.remove('active');
        setTimeout(() => {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('successStep').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successStep').classList.add('active');
            }, 50);
        }, 500);

    } catch (error) {
        console.error(error);
        loading.style.display = 'none';
        btn.style.display = 'block';
        btn.disabled = false;
        document.getElementById('errorMessage').style.display = 'block';
    }
}

function getYearsFromDate(dateString) {
    if (!dateString) return "";
    const start = new Date(dateString);
    const now = new Date();
    const diff = now - start;
    const ageDate = new Date(diff); 
    return Math.abs(ageDate.getUTCFullYear() - 1970) + " years";
}
</script>

</body>
</html>