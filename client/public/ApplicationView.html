<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Application - Today Capital Group</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 900px;
            padding: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .header {
            background: #E8EEF3;
            color: #1B2E4D;
            padding: 30px;
            margin: -40px -40px 30px -40px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img { 
            height: 50px;
            width: auto;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header p { 
            margin: 0; 
            font-size: 24px; 
            font-weight: 700;
            color: #1B2E4D;
        }
        .header-right {
            text-align: right;
        }
        .header-right .label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .header-right .date {
            font-weight: 400;
            font-size: 16px;
            margin-top: 4px;
            color: #1B2E4D;
        }
        
        .section-title {
            border-bottom: 3px solid #5FBFB8;
            color: #1B2E4D;
            font-size: 20px;
            font-weight: 700;
            padding-bottom: 8px;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .field {
            margin-bottom: 12px;
        }
        .label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .value {
            font-size: 15px;
            color: #111827;
            border: 1px solid #e5e7eb;
            padding: 12px;
            background: #f9fafb;
            min-height: 20px;
            border-radius: 4px;
        }
        .value:empty::before {
            content: '—';
            color: #9ca3af;
        }

        .btn {
            background: #5FBFB8;
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            display: block;
            margin: 40px auto 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(95, 191, 184, 0.3);
        }
        .btn:hover { 
            background: #4EAEA7;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(95, 191, 184, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px;
            }
            .header {
                flex-direction: column;
                text-align: center;
                margin: -20px -20px 20px -20px;
                padding: 20px;
            }
            .header-right {
                text-align: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>

<div class="container" id="appContent">
    <div class="header">
        <div class="header-left">
            <img src="https://cdn.prod.website-files.com/6864b4e14db4a4b6864c7968/686c1b87657a831f612b5390_Group%2017%20(1).svg" alt="Today Capital Group" />
        </div>
        <div class="header-right">
            <div class="date" id="submissionDate">—</div>
        </div>
    </div>

    <div class="section-title">Business Information</div>
    <div class="grid">
        <div class="field">
            <div class="label">Legal Business Name</div>
            <div class="value" id="legal_business_name"></div>
        </div>
        <div class="field">
            <div class="label">Doing Business As (DBA)</div>
            <div class="value" id="doing_business_as"></div>
        </div>
        <div class="field">
            <div class="label">Company Website</div>
            <div class="value" id="company_website"></div>
        </div>
        <div class="field">
            <div class="label">Business Start Date</div>
            <div class="value" id="business_start_date"></div>
        </div>
        <div class="field">
            <div class="label">Tax ID / EIN</div>
            <div class="value" id="ein"></div>
        </div>
        <div class="field">
            <div class="label">Business Email</div>
            <div class="value" id="business_email"></div>
        </div>
        <div class="field">
            <div class="label">State of Incorporation</div>
            <div class="value" id="state_of_incorporation"></div>
        </div>
        <div class="field">
            <div class="label">Process Credit Cards?</div>
            <div class="value" id="do_you_process_credit_cards"></div>
        </div>
        <div class="field">
            <div class="label">Industry</div>
            <div class="value" id="industry"></div>
        </div>
        <div class="field">
            <div class="label">Business Address</div>
            <div class="value" id="business_address"></div>
        </div>
        <div class="field">
            <div class="label">City</div>
            <div class="value" id="city"></div>
        </div>
        <div class="field">
            <div class="label">State</div>
            <div class="value" id="state"></div>
        </div>
        <div class="field">
            <div class="label">ZIP Code</div>
            <div class="value" id="zip_code"></div>
        </div>
        <div class="field">
            <div class="label">Requested Financing Amount</div>
            <div class="value" id="requested_amount"></div>
        </div>
        <div class="field">
            <div class="label">Current MCA Balance</div>
            <div class="value" id="mca_balance_amount"></div>
        </div>
        <div class="field">
            <div class="label">MCA Bank Name</div>
            <div class="value" id="mca_balance_bank_name"></div>
        </div>
    </div>

    <div class="section-title">Owner Information</div>
    <div class="grid">
        <div class="field">
            <div class="label">Full Name</div>
            <div class="value" id="full_name"></div>
        </div>
        <div class="field">
            <div class="label">Email</div>
            <div class="value" id="email"></div>
        </div>
        <div class="field">
            <div class="label">Phone</div>
            <div class="value" id="phone"></div>
        </div>
        <div class="field">
            <div class="label">Social Security Number</div>
            <div class="value" id="social_security_number"></div>
        </div>
        <div class="field">
            <div class="label">Date of Birth</div>
            <div class="value" id="date_of_birth"></div>
        </div>
        <div class="field">
            <div class="label">FICO Score</div>
            <div class="value" id="fico_score"></div>
        </div>
        <div class="field">
            <div class="label">Ownership %</div>
            <div class="value" id="ownership"></div>
        </div>
        <div class="field">
            <div class="label">Home Address Line 1</div>
            <div class="value" id="owner_address1"></div>
        </div>
        <div class="field">
            <div class="label">City</div>
            <div class="value" id="owner_city"></div>
        </div>
        <div class="field">
            <div class="label">State</div>
            <div class="value" id="owner_state"></div>
        </div>
        <div class="field">
            <div class="label">ZIP Code</div>
            <div class="value" id="owner_zip"></div>
        </div>
    </div>

    <!-- Signature Section -->
    <div class="section-title">Applicant Signature</div>
    <div class="field">
        <img id="signature_image" style="max-width: 100%; border: 1px solid #e5e7eb; background: #f9fafb; padding: 12px; border-radius: 4px; display: none;" alt="Applicant Signature">
        <div id="signature_placeholder" class="value" style="text-align: center; color: #9ca3af;">No signature provided</div>
    </div>

    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 40px;">
        <button class="btn" onclick="downloadPDF(false)" style="max-width: 250px;">Download Full PDF</button>
        <button class="btn" onclick="downloadPDF(true)" style="max-width: 250px; background: #666666;">Download Redacted PDF</button>
    </div>
</div>

<script>
    // Get application ID from URL path
    const pathParts = window.location.pathname.split('/');
    const applicationId = pathParts[pathParts.length - 1];
    
    // Check if redacted mode is requested
    const urlParams = new URLSearchParams(window.location.search);
    const isRedactedMode = urlParams.get('redacted') === 'true';

    // Fetch application data
    async function loadApplicationData() {
        try {
            const response = await fetch(`/api/applications/${applicationId}/view`);
            if (!response.ok) throw new Error('Failed to load application');
            
            const data = await response.json();
            
            // Populate all fields
            document.getElementById('legal_business_name').textContent = data.legalBusinessName || data.businessName || '';
            document.getElementById('doing_business_as').textContent = data.doingBusinessAs || '';
            document.getElementById('company_website').textContent = data.companyWebsite || '';
            document.getElementById('business_start_date').textContent = data.businessStartDate || '';
            document.getElementById('ein').textContent = data.ein || '';
            document.getElementById('business_email').textContent = data.companyEmail || data.businessEmail || data.email || '';
            document.getElementById('state_of_incorporation').textContent = data.stateOfIncorporation || '';
            document.getElementById('do_you_process_credit_cards').textContent = data.doYouProcessCreditCards || '';
            document.getElementById('industry').textContent = data.industry || '';
            document.getElementById('business_address').textContent = data.businessStreetAddress || data.businessAddress || '';
            
            // Parse businessCsz (format: "City, ST 12345") into separate fields
            const businessCsz = data.businessCsz || '';
            if (businessCsz) {
                const parts = businessCsz.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    document.getElementById('city').textContent = parts[0] || '';
                    const stateZip = parts[1].split(' ').filter(p => p);
                    document.getElementById('state').textContent = stateZip[0] || '';
                    document.getElementById('zip_code').textContent = stateZip[1] || '';
                } else {
                    document.getElementById('city').textContent = data.city || '';
                    document.getElementById('state').textContent = data.state || '';
                    document.getElementById('zip_code').textContent = data.zipCode || '';
                }
            } else {
                document.getElementById('city').textContent = data.city || '';
                document.getElementById('state').textContent = data.state || '';
                document.getElementById('zip_code').textContent = data.zipCode || '';
            }
            
            document.getElementById('requested_amount').textContent = data.requestedAmount ? `$${parseFloat(data.requestedAmount).toLocaleString()}` : '';
            document.getElementById('mca_balance_amount').textContent = data.mcaBalanceAmount ? `$${parseFloat(data.mcaBalanceAmount).toLocaleString()}` : '';
            document.getElementById('mca_balance_bank_name').textContent = data.mcaBalanceBankName || '';
            
            // Owner info
            document.getElementById('full_name').textContent = data.fullName || '';
            document.getElementById('email').textContent = data.email || '';
            document.getElementById('phone').textContent = data.phone || '';
            document.getElementById('social_security_number').textContent = data.socialSecurityNumber || data.ownerSsn || '';
            document.getElementById('date_of_birth').textContent = data.dateOfBirth || data.ownerDob || '';
            document.getElementById('fico_score').textContent = data.personalCreditScoreRange || data.ficoScoreExact || data.creditScore || '';
            document.getElementById('ownership').textContent = data.ownerPercentage || data.ownership || '';
            document.getElementById('owner_address1').textContent = data.ownerAddress1 || data.address1 || '';
            
            // Parse ownerCsz (format: "City, ST 12345") into separate fields
            const ownerCsz = data.ownerCsz || '';
            if (ownerCsz) {
                const parts = ownerCsz.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    document.getElementById('owner_city').textContent = parts[0] || '';
                    const stateZip = parts[1].split(' ').filter(p => p);
                    document.getElementById('owner_state').textContent = stateZip[0] || '';
                    document.getElementById('owner_zip').textContent = stateZip[1] || '';
                } else {
                    document.getElementById('owner_city').textContent = data.ownerCity || '';
                    document.getElementById('owner_state').textContent = data.ownerState || '';
                    document.getElementById('owner_zip').textContent = data.ownerZip || '';
                }
            } else {
                document.getElementById('owner_city').textContent = data.ownerCity || '';
                document.getElementById('owner_state').textContent = data.ownerState || '';
                document.getElementById('owner_zip').textContent = data.ownerZip || '';
            }
            
            // Set submission date
            if (data.updatedAt) {
                const date = new Date(data.updatedAt);
                document.getElementById('submissionDate').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Display signature if available
            if (data.applicantSignature) {
                const signaturePlaceholder = document.getElementById('signature_placeholder');
                
                if (data.applicantSignature.startsWith('data:image')) {
                    // It's a drawn signature (legacy support)
                    const signatureImg = document.getElementById('signature_image');
                    signatureImg.src = data.applicantSignature;
                    signatureImg.style.display = 'block';
                    signaturePlaceholder.style.display = 'none';
                } else {
                    // It's a checkbox signature (ISO timestamp) - display stamp
                    signaturePlaceholder.innerHTML = `
                        <div style="padding: 20px; text-align: left;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">Digitally Signed by: ${data.fullName || 'Unknown'}</div>
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Date: ${data.applicantSignature}</div>
                            <div style="font-size: 13px; font-style: italic; color: #6b7280;">Electronic Consent Accepted</div>
                        </div>
                    `;
                    signaturePlaceholder.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('Error loading application:', error);
            alert('Failed to load application data');
        }
    }

    // Download PDF function
    function downloadPDF(isRedacted = false) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Colors - Updated to match brand
        const headerBg = [232, 238, 243]; // Light blue-gray
        const darkNavy = [27, 46, 77]; // Dark navy text
        const teal = [95, 191, 184]; // Teal accent
        
        // Header background
        doc.setFillColor(...headerBg);
        doc.rect(0, 0, 210, 40, 'F');
        
        // Load and add logo (using local PNG file)
        const logoImg = new Image();
        let pdfGenerated = false;
        
        // Helper function to generate PDF with logo
        const generateWithLogo = function() {
            if (pdfGenerated) return;
            pdfGenerated = true;
            
            try {
                // Add logo to PDF (PNG format works reliably with jsPDF)
                // Logo actual dimensions: 450x138 pixels (aspect ratio 3.26:1)
                // PDF dimensions: 60x18.4 maintains the correct aspect ratio
                doc.addImage(logoImg, 'PNG', 20, 10, 60, 18.4);
                
                // Date on right side
                const dateText = document.getElementById('submissionDate').textContent;
                doc.setTextColor(...darkNavy);
                doc.setFontSize(10);
                doc.text(`Date: ${dateText}`, 150, 20);
                
                continuePDFGeneration(doc, darkNavy, teal, isRedacted);
            } catch (error) {
                // If logo fails, fallback to text
                console.error('Failed to add logo:', error);
                generateWithoutLogo();
            }
        };
        
        // Helper function to generate PDF without logo (fallback)
        const generateWithoutLogo = function() {
            if (pdfGenerated) return;
            pdfGenerated = true;
            
            doc.setTextColor(...darkNavy);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('TODAY CAPITAL GROUP', 20, 20);
            
            const dateText = document.getElementById('submissionDate').textContent;
            doc.setFontSize(10);
            doc.text(`Date: ${dateText}`, 150, 20);
            
            continuePDFGeneration(doc, darkNavy, teal, isRedacted);
        };
        
        // Set up handlers BEFORE setting src to avoid race condition
        logoImg.onload = generateWithLogo;
        logoImg.onerror = generateWithoutLogo;
        
        // Set the source
        logoImg.src = '/assets/tcg-logo.png';
        
        // Handle case where image is already cached and complete
        if (logoImg.complete) {
            generateWithLogo();
        }
        
        // Timeout fallback to ensure PDF is always generated
        setTimeout(() => {
            generateWithoutLogo();
        }, 2000);
    }
    
    // Continue PDF generation after header
    function continuePDFGeneration(doc, darkNavy, teal, isRedacted = false) {
        let yPos = 50;
        
        // Fields to redact (hide in redacted version) - only email and phone
        const redactedFields = ['email', 'phone'];
        
        // Helper functions
        const addSectionHeader = (title) => {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...darkNavy);
            doc.text(title, 20, yPos);
            doc.setDrawColor(...teal);
            doc.setLineWidth(0.5);
            doc.line(20, yPos + 2, 60, yPos + 2);
            yPos += 10;
        };
        
        const addField = (label, value, fieldId, x, width) => {
            // Skip redacted fields in redacted mode
            if (isRedacted && redactedFields.includes(fieldId)) {
                return;
            }
            
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(100, 100, 100);
            doc.text(label, x, yPos);
            
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(250, 250, 250);
            doc.rect(x, yPos + 2, width, 8, 'FD');
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            const text = String(value || '—').substring(0, 40);
            doc.text(text, x + 2, yPos + 7);
        };
        
        // Business Information
        addSectionHeader('Business Information');
        addField('Legal Name:', document.getElementById('legal_business_name').textContent, 'legal_business_name', 20, 85);
        addField('DBA:', document.getElementById('doing_business_as').textContent, 'doing_business_as', 110, 85);
        yPos += 13;
        addField('Website:', document.getElementById('company_website').textContent, 'company_website', 20, 85);
        addField('Start Date:', document.getElementById('business_start_date').textContent, 'business_start_date', 110, 85);
        yPos += 13;
        addField('EIN:', document.getElementById('ein').textContent, 'ein', 20, 85);
        addField('Industry:', document.getElementById('industry').textContent, 'industry', 110, 85);
        yPos += 13;
        addField('Address:', document.getElementById('business_address').textContent, 'business_address', 20, 85);
        addField('City:', document.getElementById('city').textContent, 'city', 110, 85);
        yPos += 13;
        addField('State:', document.getElementById('state').textContent, 'state', 20, 40);
        addField('ZIP:', document.getElementById('zip_code').textContent, 'zip_code', 65, 40);
        addField('State of Inc:', document.getElementById('state_of_incorporation').textContent, 'state_of_incorporation', 110, 85);
        yPos += 13;
        addField('Requested Amount:', document.getElementById('requested_amount').textContent, 'requested_amount', 20, 85);
        addField('MCA Balance:', document.getElementById('mca_balance_amount').textContent, 'mca_balance_amount', 110, 85);
        yPos += 13;
        addField('Credit Cards:', document.getElementById('do_you_process_credit_cards').textContent, 'do_you_process_credit_cards', 20, 85);
        addField('MCA Bank:', document.getElementById('mca_balance_bank_name').textContent, 'mca_balance_bank_name', 110, 85);
        yPos += 20;
        
        // Owner Information
        addSectionHeader('Owner Information');
        if (isRedacted) {
            // In redacted mode: Full Name and SSN aligned on same line
            addField('Full Name:', document.getElementById('full_name').textContent, 'full_name', 20, 85);
            addField('SSN:', document.getElementById('social_security_number').textContent, 'social_security_number', 110, 85);
            yPos += 13;
            addField('Date of Birth:', document.getElementById('date_of_birth').textContent, 'date_of_birth', 20, 85);
            addField('FICO Score:', document.getElementById('fico_score').textContent, 'fico_score', 110, 85);
            yPos += 13;
            addField('Ownership %:', document.getElementById('ownership').textContent, 'ownership', 20, 85);
            addField('Home Address:', document.getElementById('owner_address1').textContent, 'owner_address1', 110, 85);
            yPos += 13;
            addField('City:', document.getElementById('owner_city').textContent, 'owner_city', 20, 85);
            addField('State:', document.getElementById('owner_state').textContent, 'owner_state', 110, 40);
            addField('ZIP:', document.getElementById('owner_zip').textContent, 'owner_zip', 155, 40);
        } else {
            // Full PDF: Original layout with all fields
            addField('Full Name:', document.getElementById('full_name').textContent, 'full_name', 20, 85);
            addField('Email:', document.getElementById('email').textContent, 'email', 110, 85);
            yPos += 13;
            addField('Phone:', document.getElementById('phone').textContent, 'phone', 20, 85);
            addField('SSN:', document.getElementById('social_security_number').textContent, 'social_security_number', 110, 85);
            yPos += 13;
            addField('Date of Birth:', document.getElementById('date_of_birth').textContent, 'date_of_birth', 20, 85);
            addField('FICO Score:', document.getElementById('fico_score').textContent, 'fico_score', 110, 85);
            yPos += 13;
            addField('Ownership %:', document.getElementById('ownership').textContent, 'ownership', 20, 85);
            addField('Home Address:', document.getElementById('owner_address1').textContent, 'owner_address1', 110, 85);
            yPos += 13;
            addField('City:', document.getElementById('owner_city').textContent, 'owner_city', 20, 85);
            addField('State:', document.getElementById('owner_state').textContent, 'owner_state', 110, 40);
            addField('ZIP:', document.getElementById('owner_zip').textContent, 'owner_zip', 155, 40);
        }
        yPos += 25;
        
        // Signature Section - Two column layout
        // Get signature data from the DOM
        const signatureData = {
            src: document.getElementById('signature_image').src,
            isVisible: document.getElementById('signature_image').style.display !== 'none',
            fullName: document.getElementById('full_name').textContent,
            timestamp: null
        };
        
        // Check if it's a checkbox signature by looking at the placeholder content
        const signaturePlaceholder = document.getElementById('signature_placeholder');
        const isCheckboxSignature = signaturePlaceholder && signaturePlaceholder.style.display !== 'none' && signaturePlaceholder.innerHTML.includes('Digitally Signed by');
        
        if ((signatureData.src && signatureData.isVisible) || isCheckboxSignature) {
            try {
                // LEFT COLUMN: Disclosure text
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const disclosureText = 'Confirm Application\nBy signing below, each of the listed business and business owner/officer (individually and collectively, "you") authorize Today Capital Group and its representatives, successors, assigns, and designees involved with or acquiring commercial loans or purchases of future receivables, including Merchant Cash Advance transactions (collectively, "Transactions"), to obtain consumer or personal, business, and investigative reports and other information about you. This includes credit card processor statements and bank statements from consumer reporting agencies such as TransUnion, Experian, and Equifax, Identity IQ, and other credit bureaus, banks, creditors, government agencies, and third parties (the "Recipients"). You also authorize Today Capital Group to transmit this application form, along with any obtained information, to any or all of the Recipients for the stated purposes. Furthermore, you consent to any creditor or financial institution releasing information about you to Today Capital Group and the Recipients. You authorize Today Capital Group to communicate with the Recipients on your behalf and represent you in dealings with them. Additionally, you permit Today Capital Group';
                const splitDisclosure = doc.splitTextToSize(disclosureText, 95);
                doc.text(splitDisclosure, 20, yPos);
                
                // RIGHT COLUMN: Signature header
                const signatureStartY = yPos;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...darkNavy);
                doc.text('Applicant Signature', 120, signatureStartY);
                doc.setDrawColor(...teal);
                doc.setLineWidth(0.5);
                doc.line(120, signatureStartY + 2, 175, signatureStartY + 2);
                
                // Add signature (image or stamp)
                if (isCheckboxSignature) {
                    // Checkbox signature - display stamp using the stored ISO timestamp
                    const stampY = signatureStartY + 10;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Digitally Signed by: ${signatureData.fullName}`, 120, stampY);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100, 100, 100);
                    // Extract timestamp from the placeholder's innerHTML
                    const timestampMatch = signaturePlaceholder.innerHTML.match(/Date: ([^<]+)</);
                    const timestamp = timestampMatch ? timestampMatch[1] : new Date().toISOString();
                    doc.text(`Date: ${timestamp}`, 120, stampY + 6);
                    
                    doc.setFont('helvetica', 'italic');
                    doc.text('Electronic Consent Accepted', 120, stampY + 11);
                } else if (signatureData.src && signatureData.isVisible) {
                    // Drawn signature (legacy support)
                    doc.addImage(signatureData.src, 'PNG', 120, signatureStartY + 8, 70, 21);
                }
            } catch (error) {
                console.error('Failed to add signature to PDF:', error);
            }
        }
        
        // Save PDF
        const businessName = document.getElementById('legal_business_name').textContent || 'Application';
        const redactedSuffix = isRedacted ? '_Redacted' : '';
        const fileName = `Application_${businessName.replace(/[^a-z0-9]/gi, '_')}${redactedSuffix}.pdf`;
        doc.save(fileName);
    }

    // Load data on page load
    loadApplicationData();
</script>

</body>
</html>
